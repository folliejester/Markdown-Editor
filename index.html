<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor</title>
    <link rel="icon" href="./icon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@2.3.6/dist/purify.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" xintegrity="sha512-iecdLp3E7B8fG0J8g9a74R54sT13uL5E+sL6P5eBf6Gz7t5R5yU5O5R5eG5L5sL5g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6;
            transition: background-color 0.3s ease;
        }
        body.dark {
            background-color: #121212;
        }
        body.dark .bg-white {
            background-color: #1a1a1a;
        }
        body.dark .bg-gray-50 {
            background-color: #121212;
        }
        body.dark .bg-gray-100 {
            background-color: #1f1f1f;
        }
        body.dark .border-gray-200 {
            border-color: #333333;
        }
        body.dark .border-gray-300 {
            border-color: #333333;
        }
        body.dark .text-gray-800 {
            color: #e2e8f0;
        }
        body.dark .text-gray-700 {
            color: #d1d5db;
        }
        body.dark .text-gray-500 {
            color: #a0aec0;
        }
        body.dark .bg-gray-200 {
            background-color: #2d2d2d;
        }
        body.dark .hover\\:bg-gray-300:hover {
            background-color: #4a4a4a;
        }
        body.dark .custom-button {
            color: #e2e8f0; 
        }
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .markdown-preview h1, .markdown-preview h2, .markdown-preview h3, .markdown-preview h4, .markdown-preview h5, .markdown-preview h6 {
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            line-height: 1.25;
        }
        .markdown-preview h1 { font-size: 2.25rem; }
        .markdown-preview h2 { font-size: 1.875rem; }
        .markdown-preview h3 { font-size: 1.5rem; }
        .markdown-preview h4 { font-size: 1.25rem; }
        .markdown-preview h5 { font-size: 1.125rem; }
        .markdown-preview h6 { font-size: 1rem; }
        .markdown-preview p { margin-bottom: 1rem; }
        .markdown-preview ul {
            list-style-type: disc;
            padding-left: 2rem;
            margin-bottom: 1rem;
        }
        .markdown-preview ul ul {
            list-style-type: circle;
        }
        .markdown-preview ul ul ul {
            list-style-type: square;
        }
        .markdown-preview ol {
            list-style-type: decimal;
            padding-left: 2rem;
            margin-bottom: 1rem;
        }
        .markdown-preview li {
        }
        .markdown-preview blockquote {
            border-left: 4px solid #d1d5db;
            padding-left: 1rem;
            color: #6b7280;
            font-style: italic;
            margin-bottom: 1rem;
        }
        body.dark .markdown-preview {
            color: #e2e8f0;
        }
        body.dark .markdown-preview blockquote {
            border-color: #6b7280;
            color: #a0aec0;
        }
        .markdown-preview pre {
            background-color: #f1f1f1;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 1rem;
        }
        body.dark .markdown-preview pre {
            background-color: #2d2d2d;
        }
        .markdown-preview code {
            background-color: #e5e7eb;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        body.dark .markdown-preview code {
            background-color: #3d3d3d;
        }
        .markdown-preview pre code {
            background-color: transparent;
            padding: 0;
        }
        .markdown-preview table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .markdown-preview th, .markdown-preview td {
            border: 1px solid #d1d5db;
            padding: 0.75rem;
            text-align: left;
        }
        .markdown-preview th {
            background-color: #e5e7eb;
            font-weight: bold;
        }
        body.dark .markdown-preview th {
            background-color: #2d2d2d;
        }
        .markdown-preview img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
        }
        .markdown-preview a {
            color: #3b82f6;
            text-decoration: underline;
        }
        .markdown-preview input[type="checkbox"] {
            vertical-align: middle;
            transform: translateY(-0.125rem);
        }
        .preview-only #editor-pane {
            display: none;
        }
        .preview-only #preview-pane {
            width: 100%;
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    <div id="message-box" class="message-box"></div>
    <header class="flex items-center justify-between p-4 bg-white border-b border-gray-200 shadow-sm flex-wrap space-y-2 sm:space-y-0">
        <h1 class="text-xl font-bold text-gray-800">Markdown Editor</h1>
        <div class="flex items-center space-x-4">
            <div class="flex items-center text-sm font-medium text-gray-700 space-x-1">
                <i class="fas fa-file-word"></i>
                <span id="word-count">0 words</span>
            </div>
            <div class="flex items-center text-sm font-medium text-gray-700 space-x-1">
                <i class="fas fa-keyboard"></i>
                <span id="char-count">0 characters</span>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <button id="undo-btn" class="custom-button" title="Undo" disabled>
                <i class="fas fa-undo"></i>
            </button>
            <button id="redo-btn" class="custom-button" title="Redo" disabled>
                <i class="fas fa-redo"></i>
            </button>
            <button id="reset-btn" class="custom-button" title="Reset">
                <i class="fas fa-trash"></i>
            </button>
            <button id="sync-btn" class="custom-button" title="Sync On">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button id="copy-btn" class="custom-button" title="Copy">
                <i class="fas fa-copy"></i>
            </button>
            <button id="download-btn" class="custom-button" title="Download">
                <i class="fas fa-download"></i>
            </button>
            <button id="theme-btn" class="custom-button" title="Toggle Dark Mode">
                <i class="fas fa-moon"></i>
            </button>
            <button id="preview-btn" class="custom-button" title="Preview Only">
                <i class="fas fa-eye"></i>
            </button>
        </div>
    </header>
    <div class="p-2 bg-gray-100 border-b border-gray-200">
        <div class="flex flex-wrap space-x-4 w-full">
            <button class="custom-button toolbar-btn" data-markdown-action="heading" title="Heading">
                <i class="fas fa-heading"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="bold" title="Bold">
                <i class="fas fa-bold"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="italic" title="Italic">
                <i class="fas fa-italic"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="strikethrough" title="Strikethrough">
                <i class="fas fa-strikethrough"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="link" title="Link">
                <i class="fas fa-link"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="image" title="Image">
                <i class="fas fa-image"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="quote" title="Quote">
                <i class="fas fa-quote-right"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="codeBlock" title="Code Block">
                <i class="fas fa-code"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="unorderedList" title="Unordered List">
                <i class="fas fa-list-ul"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="orderedList" title="Ordered List">
                <i class="fas fa-list-ol"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="checkedList" title="Checked List">
                <i class="fas fa-tasks"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="table" title="Table">
                <i class="fas fa-table"></i>
            </button>
            <button class="custom-button toolbar-btn" data-markdown-action="line" title="Horizontal Rule">
                <i class="fas fa-minus"></i>
            </button>
        </div>
    </div>
    <main id="main-content" class="flex-grow flex flex-col md:flex-row bg-gray-50 overflow-hidden">
        <div id="editor-pane" class="flex-1 flex flex-col p-4 border-r border-gray-200">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Editor</h2>
            <textarea id="markdown-input" class="flex-1 p-4 text-gray-800 bg-white border border-gray-300 rounded-lg resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 no-scrollbar"></textarea>
        </div>
        <div id="preview-pane" class="flex-1 flex flex-col p-4 overflow-y-auto no-scrollbar">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Preview</h2>
            <div id="markdown-preview" class="markdown-preview flex-1 p-4 bg-white border border-gray-300 rounded-lg overflow-y-auto no-scrollbar">
                <p class="text-gray-500 text-center italic">Start typing in the editor to see your Markdown rendered here.</p>
            </div>
        </div>
    </main>
    <script>
        marked.setOptions({
            gfm: true,
            breaks: true,
            renderer: {
                space: () => '',
                hr: () => `<hr>`,
                html: (html) => html,
                paragraph: (text) => `<p>${text}</p>`,
                heading: (text, level) => `<h${level}>${text}</h${level}>`,
                strong: (text) => `<strong>${text}</strong>`,
                em: (text) => `<em>${text}</em>`,
                del: (text) => `<del>${text}</del>`,
                code: (code, lang) => `<pre><code>${code}</code></pre>`,
                codespan: (text) => `<code>${text}</code>`, 
                blockquote: (quote) => `<blockquote>${quote}</blockquote>`,
                br: () => `<br>`, 
                text: (text) => text,
                link: (href, title, text) => `<a href="${href}" title="${title}" target="_blank">${text}</a>`,
                image: (href, title, text) => `<img src="${href}" alt="${text}" title="${title}" loading="lazy" />`,
                list: (body, ordered, start) => {
                    const tag = ordered ? 'ol' : 'ul';
                    return `<${tag}>${body}</${tag}>`;
                },
                listitem: (text, task, checked) => {
                    if (task) {
                        const content = text.replace(/<p>|<\/p>/g, '');
                        return `<li class="flex items-center">${content}</li>`;
                    }
                    return `<li>${text}</li>`;
                },
                checkbox: (checked) => {
                    return `<input type="checkbox" disabled ${checked ? 'checked' : ''} class="form-checkbox text-blue-600 rounded mr-2" />`;
                },
                table: (header, body) => `<table><thead>${header}</thead><tbody>${body}</tbody></table>`,
                tablerow: (content) => `<tr>${content}</tr>`,
                tablecell: (content, flags) => `<td>${content}</td>`
            }
        });
        const markdownInput = document.getElementById('markdown-input');
        const markdownPreview = document.getElementById('markdown-preview');
        const toolbarButtons = document.querySelectorAll('.toolbar-btn');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const resetBtn = document.getElementById('reset-btn');
        const syncBtn = document.getElementById('sync-btn');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn');
        const themeBtn = document.getElementById('theme-btn');
        const previewBtn = document.getElementById('preview-btn');
        const mainContent = document.getElementById('main-content');
        const messageBox = document.getElementById('message-box');
        const wordCountDisplay = document.getElementById('word-count');
        const charCountDisplay = document.getElementById('char-count');
        let history = [''];
        let historyIndex = 0;
        let isSyncEnabled = true;
        const showMessage = (message) => {
            messageBox.textContent = message;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 2000);
        };
        const updateCounts = () => {
            const text = markdownInput.value;
            const words = text.match(/\b\w+\b/g);
            const wordCount = words ? words.length : 0;
            const charCount = text.length;
            wordCountDisplay.textContent = `${wordCount} word${wordCount === 1 ? '' : 's'}`;
            charCountDisplay.textContent = `${charCount} character${charCount === 1 ? '' : 's'}`;
        };
        const renderMarkdown = () => {
            const markdownText = markdownInput.value;
            const rawHtml = marked.parse(markdownText);
            const cleanHtml = DOMPurify.sanitize(rawHtml);
            markdownPreview.innerHTML = cleanHtml;
        };
        const updateHistoryButtons = () => {
            undoBtn.disabled = historyIndex === 0;
            redoBtn.disabled = historyIndex === history.length - 1;
        };
        const handleInput = () => {
            renderMarkdown();
            updateCounts();
            const currentValue = markdownInput.value;
            if (currentValue !== history[historyIndex]) {
                history = history.slice(0, historyIndex + 1);
                history.push(currentValue);
                historyIndex++;
            }
            updateHistoryButtons();
            try {
                localStorage.setItem('markdownContent', markdownInput.value);
            } catch (e) {
                console.error("Could not save to local storage:", e);
            }
        };
        markdownInput.addEventListener('input', handleInput);
        resetBtn.addEventListener('click', () => {
            markdownInput.value = '';
            try {
                localStorage.removeItem('markdownContent');
            } catch (e) {
                console.error("Could not remove from local storage:", e);
            }
            handleInput();
        });
        copyBtn.addEventListener('click', () => {
            markdownInput.select();
            document.execCommand('copy');
            showMessage('Copied to clipboard!');
        });
        downloadBtn.addEventListener('click', () => {
            const filename = 'document.md';
            const text = markdownInput.value;
            const blob = new Blob([text], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage('Download started!');
        });
        undoBtn.addEventListener('click', () => {
            if (historyIndex > 0) {
                historyIndex--;
                markdownInput.value = history[historyIndex];
                renderMarkdown();
                updateCounts();
                updateHistoryButtons();
            }
        });
        redoBtn.addEventListener('click', () => {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                markdownInput.value = history[historyIndex];
                renderMarkdown();
                updateCounts();
                updateHistoryButtons();
            }
        });
        syncBtn.addEventListener('click', () => {
            isSyncEnabled = !isSyncEnabled;
            syncBtn.title = isSyncEnabled ? 'Sync On' : 'Sync Off';
            showMessage(`Syncing is now ${isSyncEnabled ? 'on' : 'off'}.`);
        });
        const isDarkMode = localStorage.getItem('theme') === 'dark';
        const body = document.body;
        const themeIcon = themeBtn.querySelector('i');
        const updateTheme = (isDark) => {
            if (isDark) {
                body.classList.add('dark');
                themeIcon.classList.remove('fa-moon');
                themeIcon.classList.add('fa-sun');
                themeBtn.title = 'Toggle Light Mode';
            } else {
                body.classList.remove('dark');
                themeIcon.classList.remove('fa-sun');
                themeIcon.classList.add('fa-moon');
                themeBtn.title = 'Toggle Dark Mode';
            }
        };
        themeBtn.addEventListener('click', () => {
            const newThemeIsDark = !body.classList.contains('dark');
            updateTheme(newThemeIsDark);
            localStorage.setItem('theme', newThemeIsDark ? 'dark' : 'light');
        });
        previewBtn.addEventListener('click', () => {
            const isPreviewOnly = mainContent.classList.toggle('preview-only');
            const previewIcon = previewBtn.querySelector('i');
            if (isPreviewOnly) {
                previewBtn.title = 'Show Editor';
                previewIcon.classList.remove('fa-eye');
                previewIcon.classList.add('fa-eye-slash');
            } else {
                previewBtn.title = 'Preview Only';
                previewIcon.classList.remove('fa-eye-slash');
                previewIcon.classList.add('fa-eye');
            }
        });
        const syncScroll = (source, target) => {
            if (!isSyncEnabled) return;
            const scrollPercentage = source.scrollTop / (source.scrollHeight - source.clientHeight);
            target.scrollTop = scrollPercentage * (target.scrollHeight - target.clientHeight);
        };
        markdownInput.addEventListener('scroll', () => {
            syncScroll(markdownInput, markdownPreview);
        });
        markdownPreview.addEventListener('scroll', () => {
            syncScroll(markdownPreview, markdownInput);
        });
        toolbarButtons.forEach(button => {
            button.addEventListener('click', () => {
                const action = button.dataset.markdownAction; 
                const { selectionStart, selectionEnd } = markdownInput;
                const selectedText = markdownInput.value.substring(selectionStart, selectionEnd);
                let newText;
                switch (action) {
                    case 'heading':
                        newText = `# ${selectedText || 'Heading'}`;
                        break;
                    case 'bold':
                        newText = `**${selectedText || 'bold text'}**`;
                        break;
                    case 'italic':
                        newText = `*${selectedText || 'italic text'}*`;
                        break;
                    case 'strikethrough':
                        newText = `~~${selectedText || 'strikethrough text'}~~`;
                        break;
                    case 'quote':
                        newText = `> ${selectedText || 'Quote'}`;
                        break;
                    case 'codeBlock':
                        newText = `\`\`\`javascript\n${selectedText || 'const x = 1;'}\n\`\`\``;
                        break;
                    case 'link':
                        const linkText = selectedText || 'link text';
                        const linkUrl = prompt('Enter the URL:', 'https://example.com');
                        if (linkUrl !== null) {
                            newText = `[${linkText}](${linkUrl})`;
                        }
                        break;
                    case 'image':
                        const altText = selectedText || 'alt text';
                        const imageUrl = prompt('Enter the Image URL:', 'https://placehold.co/400x200');
                        if (imageUrl !== null) {
                            newText = `![${altText}](${imageUrl})`;
                        }
                        break;
                    case 'unorderedList':
                        newText = `- ${selectedText || 'Item 1'}\n- Item 2\n- Item 3`;
                        break;
                    case 'orderedList':
                        newText = `1. ${selectedText || 'Item 1'}\n2. Item 2\n3. Item 3`;
                        break;
                    case 'checkedList':
                        newText = `- [ ] ${selectedText || 'Task 1'}\n- [x] Task 2\n- [ ] Task 3`;
                        break;
                    case 'table':
                        newText = `| Header 1 | Header 2 |\n| --- | --- |\n| Cell 1 | Cell 2 |\n| Cell 3 | Cell 4 |`;
                        break;
                    case 'line':
                        newText = `\n---\n`;
                        break;
                    default:
                        newText = '';
                }
                if (newText) {
                    markdownInput.setRangeText(newText, selectionStart, selectionEnd, 'end');
                    markdownInput.focus();
                    handleInput();
                }
            });
        });
        document.addEventListener('DOMContentLoaded', () => {
            if (isDarkMode) {
                updateTheme(true);
            }
            let initialContent = `# Welcome to the Markdown Editor\n\nThis is a live preview. Start typing on the left to see the result here.\n\n## Features\n\n* **Headers:** Use # for different heading sizes.\n* **Lists:**\n    * Unordered: Use a hyphen (-) or asterisk (*).\n    * Ordered: Use numbers followed by a period.\n    * Checked: Use - [ ] or - [x] to create checkboxes.\n* **Formatting:**\n    * **Bold:** \`**text**\`\n    * *Italic:* \`*text*\`\n    * ~~Strikethrough:~~ \`~~text~~\`\n* **Code Blocks:** Use backticks to highlight inline code \`like this\` or three backticks for a full code block.\n\n\`\`\`javascript\nconst hello = 'world';\nconsole.log(hello);\n\`\`\`\n\n> This is a blockquote, often used for quotes.\n\n### Tables\n\n| Feature | Status |\n|---|---|\n| Sync Scroll | ✅ |\n| Undo/Redo | ✅ |\n\nAnd here's a link to [Google](https://google.com).\n\n![A placeholder image](https://placehold.co/400x200/55a0e3/ffffff?text=Image+Example)\n\nHappy writing!`;
            try {
                const savedContent = localStorage.getItem('markdownContent');
                if (savedContent !== null && savedContent !== '') {
                    initialContent = savedContent;
                }
            } catch (e) {
                console.error("Could not access local storage:", e);
            }
            markdownInput.value = initialContent;
            handleInput();
            history[0] = markdownInput.value;
            updateHistoryButtons();
        });
    </script>
</body>
</html>
